Docker: создание и управление контейнерами

## 1. Цель работы

Целью работы является изучение работы с программным обеспечением Docker для автоматизации развертывания и управления приложениями в средах с поддержкой контейнеризации.

## 2. Теоретическая часть

## Docker

Docker — программное обеспечение (ПО) для автоматизации развёртывания и управления приложениями в средах с поддержкой контейнеризации, контейнеризатор приложений. Позволяет «упаковать» приложение со всем его окружением и зависимостями в контейнер, который может быть развёрнут на любой Linux-системе с поддержкой контрольных групп в ядре, а также предоставляет набор команд для управления этими контейнерами.

Docker — это открытая платформа для разработки, доставки и запуска приложений. Docker позволяет отделить приложения от инфраструктуры, чтобы в дальнейшем быстро выполнять «доставку» программного обеспечения.

## 2.1 Платформа Docker

Docker предоставляет возможность упаковывать и запускать приложение в изолированной среде, называемой контейнером. Можно запускать множество контейнеров одновременно на одном хосте. Контейнеры достаточно легки и содержат все необходимое для запуска приложения, поэтому не требуется устанавливать на хосте дополнительное ПО. Также контейнеры можно передавать на другие машины и их там запускать, при этом работать будет все одинаково.

Docker предоставляет инструменты и платформу для управления жизненным циклом контейнеров:
- разработка приложений и компонентов с помощью контейнеров;
- контейнер становится единицей распространения и тестирования приложения;
- приложение разворачивается в рабочей среде в виде контейнера.
    

Использовать Docker можно для:
- быстрой и последовательной доставки приложений;
- адаптивного развертывания и масштабирования;
- запуска большего количества рабочих приложений.

## 2.2 Архитектура Docker

Docker использует клиент-серверную архитектуру. Клиент Docker взаимодействует с демоном Docker, который выполняет работу по созданию, запуску и распространению контейнеров Docker. Клиент Docker и демон могут работать в одной системе, или можно подключить клиент Docker к удаленному демону Docker. Клиент Docker и демон взаимодействуют с помощью REST API, через сокеты UNIX или сетевой интерфейс. Еще один клиент Docker — Docker Compose, который позволяет работать с приложениями, состоящими из набора контейнеров (рисунок 1).

<img width="900" height="466" alt="image" src="https://github.com/user-attachments/assets/c02a37f0-c1d6-42a9-9e45-0d81d7a8ee10" />
Рис. 1. Архитектура Docker

Демон Docker (dockerd) прослушивает запросы Docker API и управляет объектами Docker (образы, контейнеры, сети и volume). Клиент Docker (docker) – это способ взаимодействия пользователей с Docker. Когда используются команды, то клиент отправляет эти команды в демон Docker, который их выполняет.

Docker registries хранит образы Docker. В лабораторной работе будет использоваться Docker Hub – это общедоступный registry (реестр), который может использовать любой пользователь.

Образ (image) Docker – это шаблон доступный только для чтения (read only) с инструкциями по созданию контейнера Docker. Образы часто основаны на других образах с некоторыми дополнительными настройками. Можно создавать свои образы или пользоваться существующими образами.

Контейнер (container) Docker – это исполняемый экземпляр образа. Контейнеры можно создавать, запускать, останавливать, перемещать или удалять с помощью Docker API или CLI. Контейнеры можно подключать к сети или нескольким сетям, а также к контейнеру можно подключить некоторое хранилище.

## 2.3 Установка Docker Engine на Ubuntu 20.04

Платформа Docker (Docker Platform) — это программа, которая даёт возможность упаковывать приложения в контейнеры и запускать их на серверах. Платформа Docker позволяет помещать в контейнеры код и его зависимости.

Docker Engine — это технология контейнеризации с открытым исходным кодом для создания и контейнеризации приложений. Docker Engine работает как клиент-серверное приложение.

Компания Docker разделила движок Docker на два продукта: Docker Community Edition (CE) и Docker Enterprise. Первый продукт бесплатный, а второй платный, дающий пользователям дополнительные возможности в области поддержки систем, управления им и безопасности. В рамках лабораторной работы будет использоваться Docker CE.

Рассмотрим процесс установки Docker Engine в дистрибутиве Ubuntu 20.04:
1. Если присутствуют старые версии Docker, то требуется их предварительно удалить, например, командой apt remove <имя_пакета>. Образы, контейнеры, volume и сети, хранящиеся в `/var/lib/docker`, автоматически не удаляются.
2. Обновляем индекс пакетов командой: `apt update`
3. Выполняем установку необходимых пакетов, перед установкой Docker:  
    `apt install apt-transport-https ca-certificates curl software-properties-common`
4. Добавляем официальный GPG-ключ Docker:  
    `curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -`
5. Выполняем настройку репозитория:  
    `add-apt-repository "deb [arch=amd64] [https://download.docker.com/linux/ubuntu](https://download.docker.com/linux/ubuntu) bionic stable"`
6. Выполняем установку Docker Engine:  
    `apt install docker-ce docker-ce-cli containerd.io docker-compose-plugin`
7. Проверяем, что Docker установлен и работает:  
	`systemctl status docker`

Если установка Docker выполнена верно, то статус сервиса будет равен `«active (running)»`, как показано на рисунке 2.

<img width="1108" height="362" alt="image" src="https://github.com/user-attachments/assets/a7a15f95-a362-4981-a76e-4a821653504d" />
Рис. 2. Статус Docker

Для работы с Docker от текущего пользователя требуется добавить пользователя в группу docker и перезапустить сеанс.

Требуется настроить доступ к proxy-серверу для Docker при работе в дисплейных классах кафедры: создается файл `/etc/system/system/docker.service.d/http-proxy.conf` и далее в него вносится информация по сервису, показанная на рисунке 3.

<img width="920" height="138" alt="image" src="https://github.com/user-attachments/assets/818604f6-cc82-4059-8a46-ce9b118fe2ff" />
Рис. 3. Файл http-proxy.conf

После сохранения данного файла, потребуется перезагрузить демоны и docker, это выполняется командами:

- `systemctl daemon-reload`
- `systemctl restart docker`

## 2.4 Команды для управления контейнерами

Общий синтаксис: `docker container [название команды]`, где иногда ключевое слово container опускают, так как подразумевается работа с контейнерами по умолчанию.

Названия команд:
- `create` — создает контейнер из выбранного образа;
- `start` — запускает существующий контейнер;
- `run` — создает новый контейнер и сразу его запускает;
- `ls` — отображает все существующие контейнеры;
- `inspect` — подробнее рассказывает о выбранном контейнере;
- `logs` — выводит в консоль логи (журнал событий);
- `stop` — пытается остановить выбранный контейнер, отправив ему сигнал SIGTERM, требующий завершить всю активность и сохранить пользовательские данные. Если ответ занимает слишком много времени, то следом посылает сигнал SIGKILL, чтобы «убить» процесс без сохранения данных;
- `kill` — выполняет ту же задачу, что и предыдущая команда, но пропускает шаг с отправкой SIGTERM. Сразу выключает контейнер, игнорируя сохранение пользовательских данных;
- `rm` — удаляет выбранный контейнер (он должен быть выключен, чтобы команда сработала, либо можно использовать флаг –f для принудительного удаления).
## 2.4.1 Команда docker create

Синтаксис:  
`docker create [опции] название образа [дополнительные команды] [аргументы]`

## 2.4.2 Команда docker start

Синтаксис:  
`docker start [опции] название или ID контейнера [название или ID контейнера]`

## 2.4.3 Команда docker run

Синтаксис:  
`docker run [опции] название образа [команды][аргументы]`

## 2.4.4 Команда docker stop

Синтаксис:  
`docker stop [опции] название или ID контейнера [название или ID контейнера]`

## 2.4.5 Команда docker restart

Синтаксис:  
`docker restart [опции] название или ID контейнера [название или ID контейнера]`

## 2.4.6 Команда docker container ls (docker ps)

Команда `docker ps` отображает в терминале все запущенные контейнеры. При добавлении опции `-a` в список попадают все контейнеры, созданные в системе.

Вывод команды содержит параметры:
- `ID` — кодовое значение конкретного контейнера;
- `IMAGE` — образ, используемый контейнером;
- `COMMAND` — команды, которые должны выполняться сразу после запуска;
- `CREATED` — время создания контейнера (например, «35 минут назад»);
- `STATUS` — текущее состояние и время работы с последнего запуска;
- `PORTS` — порты, используемые контейнером;
- `NAMES` — имена контейнеров для удобства использования.

## 2.4.7 Команда docker logs

Показывает, как функционирует контейнер и что в текущий момент с ним происходит, выводит журнал данных о выбранном контейнере.

## 2.4.8 Команда docker inspect

Синтаксис:  
`docker inspect [опции] название или ID контейнера [название или ID контейнера]`

Отображает подробную информацию о контейнере в формате JSON. Можно использовать опцию `–format`для смены формата данных.

## 2.4.9 Команда docker rm

Синтаксис:  
`docker rm [опции] название или ID контейнера [название или ID контейнера]`

## 2.5 Команды для управления образами

Для управления образами в Docker существуют команды:

- `build` — собирает образ с нуля;
- `push` — отправляет образ в реестр;
- `pull` — загружает готовый образ;
- `ls` — показывает все существующие образы;
- `history` — показывает каждый слой образа;
- `inspect` — предоставляет информацию об образе;
- `rm` — удаляет образ Docker из системы;
- `images` — списком показывает все образы на диске.

Общий синтаксис команд:  `docker image [название команды]`

## 2.6 Dockerfile

В файлах Dockerfile содержатся инструкции по созданию образа. Инструкции обрабатываются сверху вниз.

Инструкции Dockerfile:

1. `FROM` — задаёт базовый (родительский) образ.
2. `LABEL` — описывает метаданные (например, кто создал и поддерживает образ).
3. `ENV` — устанавливает постоянные переменные среды.
4. `RUN` — выполняет команду и создаёт слой образа (используется для установки пакетов).
5. `COPY` — копирует файлы и папки в контейнер.
6. `ADD` — копирует файлы и папки, может распаковывать локальные .tar файлы.
7. `CMD` — описывает команду с аргументами для выполнения при запуске контейнера (может быть только одна инструкция CMD).
8. `WORKDIR` — задаёт рабочую директорию для следующей инструкции.
9. `ARG` — задаёт переменные для передачи Docker во время сборки образа.
10. `ENTRYPOINT` — предоставляет команду с аргументами для выполнения контейнера (аргументы не переопределяются).
11. `EXPOSE` — указывает необходимость открыть порт.
12. `VOLUME` — создаёт точку монтирования для постоянного хранения.

Слои в итоговом образе создают только инструкции `FROM`, `RUN`, `COPY` и `ADD`. Другие инструкции настраивают, описывают метаданные, или сообщают Docker, что во время выполнения контейнера нужно что-то сделать.

## 2.7 Docker-compose

Docker-compose — надстройка над Docker, написанная на Python, которая позволяет запускать множество контейнеров одновременно и маршрутизировать потоки данных между ними.

Docker Compose используется для одновременного управления несколькими контейнерами, входящими в состав приложения.

Для установки:  `apt install docker-compose`

Для работы с docker-compose создаётся файл `docker-compose.yml`, содержащий инструкции для запуска и настройки сервисов. Этот файл имеет расширение `.yml`, что означает использование языка сериализации данных, понятного человеку.

## 3. Задание на лабораторную работу

Выполнить установку Docker Engine и docker-compose. Собрать необходимые образы для работы веб-приложения app.py и запустить соответствующие контейнеры.

## 4. Методика выполнения задания
1. Изучить теоретическую часть по Docker, docker-compose.
2. Установить необходимые пакеты для работы с Docker (Docker Engine и docker-compose).
4. Создать Dockerfile для нашего приложения, предусмотреть проброс порта 1234.
5. Собрать образ Docker на основе созданного Dockerfile.
6. Запустить контейнер с приложением, проверить, что при обращении по адресу [http://localhost:1234/](http://localhost:1234/) возвращается "Привет мир!".
7. Написать docker-compose.yml для развертывания этого приложения вместе с базой данных PostgreSQL, предусмотреть проброс порта 1234, а также возможность расширения или подключения сторонних сервисов при необходимости.
8. Запустить стек через docker-compose и убедиться что подключение к базе данных произошло успешно.
## 5. Требования к содержанию и оформлению отчета

Отчет должен содержать:  
а) ФИО и группу студента;  
б) описание хода выполнения работы;  
в) заключение по выполненной работе;  
г) ответы на контрольные вопросы.

---

### Может пригодиться
- https://habr.com/ru/articles/260329/ - запуск docker-compose под windows
- https://www.docker.com/get-started/ - документация по docker
- https://habr.com/ru/articles/750912/ - установка bash терминала на windows (для удобства)


- на Windows - Docker Desktop автоматически устанавливает wsl + docker-compose.

